<div class="container">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="text-primary">Editar Diagnóstico</h2>
      <p class="text-color-secondary">Actualizar información del diagnóstico médico</p>
    </div>
    <button 
      pButton 
      icon="pi pi-arrow-left" 
      label="Volver" 
      class="p-button-secondary"
      (click)="onCancel()">
    </button>
  </div>

  <!-- Form Container -->
  <div class="grid">
    <div class="col-12 lg:col-8 xl:col-6">
      <p-card header="Información del Diagnóstico">
        <form [formGroup]="diagnosisForm" (ngSubmit)="onSubmit()">
          
          <!-- Información del diagnóstico actual -->
          <div class="mb-4 p-3 border-1 border-round surface-border bg-blue-50">
            <h4 class="text-blue-700 mb-2">Diagnóstico #{{ diagnosisId }}</h4>
            <p class="text-sm text-color-secondary">
              Creado para la cita #{{ diagnosis.appointment_id }}
            </p>
          </div>

          <!-- Cita Selection -->
          <div class="field mb-4">
            <label for="appointment_id" class="block font-medium mb-2">
              Cita Médica <span class="text-red-500">*</span>
            </label>
            <select
              id="appointment_id"
              formControlName="appointment_id"
              class="w-full p-3 border-1 border-round surface-border"
              [class]="isFieldInvalid('appointment_id') ? 'border-red-500' : ''">
              <option value="">Seleccione una cita</option>
              <option *ngFor="let appointment of appointments" [value]="appointment.id">
                Cita #{{ appointment.id }} - {{ formatDate(appointment.appointment_date) }} - 
                {{ getPatientName(appointment) }} - {{ getDoctorName(appointment) }}
              </option>
            </select>
            
            <small *ngIf="isFieldInvalid('appointment_id')" class="text-red-500 block mt-1">
              {{ getFieldError('appointment_id') }}
            </small>
          </div>

          <!-- Description -->
          <div class="field mb-4">
            <label for="description" class="block font-medium mb-2">
              Descripción del Diagnóstico <span class="text-red-500">*</span>
            </label>
            <textarea
              id="description"
              formControlName="description"
              rows="8"
              placeholder="Describa detalladamente el diagnóstico médico, observaciones, hallazgos, tratamiento recomendado, medicamentos recetados..."
              class="w-full p-3 border-1 border-round surface-border"
              [class]="isFieldInvalid('description') ? 'border-red-500' : ''"
              style="resize: vertical; min-height: 150px;">
            </textarea>
            
            <small *ngIf="isFieldInvalid('description')" class="text-red-500 block mt-1">
              {{ getFieldError('description') }}
            </small>
            <div class="flex justify-content-between mt-1">
              <small class="text-color-secondary">
                Mínimo 10 caracteres
              </small>
              <small 
                [class]="diagnosisForm.get('description')?.value?.length > 1000 ? 'text-red-500' : 'text-color-secondary'">
                {{ diagnosisForm.get('description')?.value?.length || 0 }}/1000 caracteres
              </small>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 justify-content-end mt-4 pt-3 border-top-1 surface-border">
            <button
              pButton
              type="button"
              label="Cancelar"
              icon="pi pi-times"
              class="p-button-outlined p-button-secondary"
              (click)="onCancel()"
              [disabled]="submitting">
            </button>
            <button
              pButton
              type="submit"
              label="Actualizar Diagnóstico"
              icon="pi pi-check"
              class="p-button-primary"
              [disabled]="submitting || diagnosisForm.invalid">
            </button>
          </div>
        </form>
      </p-card>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center p-4">
    <i class="pi pi-spin pi-spinner text-2xl text-primary"></i>
    <p class="mt-2 text-color-secondary">Cargando diagnóstico...</p>
  </div>

  <p-toast></p-toast>
</div>